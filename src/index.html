<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Cat in Space - js13k 2025</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: monospace;
            color: #fff;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: #000;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 24px;
            display: none;
            z-index: 200;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="gameOver">
        <h2>Game Over</h2>
        <p>Final Score: <span id="finalScore">0</span></p>
        <p>Press SPACE to restart</p>
    </div>
    
    <!-- Page Lifecycle Monitor - Can be injected into any page -->
    <script>
        (function() {
            'use strict';
            
            // Page Lifecycle Monitor
            const PageMonitor = {
                events: {
                    pageLoad: null,
                    scriptLoad: null,
                    userInputListening: null
                },
                
                timestamps: {
                    start: performance.now(),
                    domContentLoaded: null,
                    load: null,
                    scriptLoad: null,
                    userInputListening: null
                },
                
                // Track when the page starts loading
                init() {
                    this.log('Page Monitor initialized');
                    
                    // Hook into DOM loading events
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', this.onDOMContentLoaded.bind(this));
                    } else {
                        this.onDOMContentLoaded();
                    }
                    
                    window.addEventListener('load', this.onPageLoad.bind(this));
                    
                    // Watch for script loading
                    this.watchScriptLoading();
                    
                    // Watch for user input event listeners
                    this.watchUserInputListening();
                },
                
                onDOMContentLoaded() {
                    this.timestamps.domContentLoaded = performance.now();
                    this.log('DOM Content Loaded');
                },
                
                onPageLoad() {
                    this.timestamps.load = performance.now();
                    this.events.pageLoad = true;
                    this.log('Page fully loaded');
                    this.reportTimings();
                },
                
                watchScriptLoading() {
                    // Monitor when our main script loads
                    const scriptObserver = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach((node) => {
                                    if (node.tagName === 'SCRIPT' && node.src && node.src.includes('script.js')) {
                                        this.onScriptLoad(node);
                                    }
                                });
                            }
                        });
                    });
                    
                    scriptObserver.observe(document.body, { childList: true });
                    
                    // Also check if script is already loaded
                    const existingScript = document.querySelector('script[src*="script.js"]');
                    if (existingScript) {
                        this.onScriptLoad(existingScript);
                    }
                },
                
                onScriptLoad(scriptElement) {
                    this.timestamps.scriptLoad = performance.now();
                    this.events.scriptLoad = true;
                    this.log('Main script loaded:', scriptElement.src);
                },
                
                watchUserInputListening() {
                    // Override addEventListener to detect when input events are listened for
                    const originalAddEventListener = EventTarget.prototype.addEventListener;
                    const self = this;
                    
                    EventTarget.prototype.addEventListener = function(type, listener, options) {
                        // Check if this is an input-related event
                        if (self.isInputEvent(type) && !self.events.userInputListening) {
                            self.onUserInputListening(type, listener);
                        }
                        
                        return originalAddEventListener.call(this, type, listener, options);
                    };
                    
                    // Also watch for input event properties being set
                    this.watchInputProperties();
                },
                
                isInputEvent(type) {
                    const inputEvents = [
                        'keydown', 'keyup', 'keypress',
                        'mousedown', 'mouseup', 'click',
                        'touchstart', 'touchend', 'touchmove',
                        'input', 'change', 'submit'
                    ];
                    return inputEvents.includes(type);
                },
                
                onUserInputListening(type, listener) {
                    this.timestamps.userInputListening = performance.now();
                    this.events.userInputListening = true;
                    this.log('User input listening detected:', type);
                    this.reportTimings();
                },
                
                watchInputProperties() {
                    // Watch for common input event properties being set
                    const inputElements = ['canvas', 'body', 'document', 'window'];
                    
                    inputElements.forEach((elementName) => {
                        const element = elementName === 'document' ? document : 
                                      elementName === 'window' ? window : 
                                      document.querySelector(elementName);
                        
                        if (element) {
                            this.watchElementProperties(element, elementName);
                        }
                    });
                },
                
                watchElementProperties(element, elementName) {
                    const inputProps = ['onkeydown', 'onkeyup', 'onclick', 'onmousedown', 'onmouseup'];
                    
                    inputProps.forEach(prop => {
                        if (element[prop] && !this.events.userInputListening) {
                            this.onUserInputListening(prop, element[prop]);
                        }
                        
                        Object.defineProperty(element, prop, {
                            set: (value) => {
                                if (value && !this.events.userInputListening) {
                                    this.onUserInputListening(prop, value);
                                }
                                // Call the original setter if it exists
                                if (element._originalSetters && element._originalSetters[prop]) {
                                    element._originalSetters[prop].call(element, value);
                                }
                            },
                            get: function() {
                                return this._inputProps ? this._inputProps[prop] : undefined;
                            },
                            configurable: true
                        });
                    });
                },
                
                log(message, ...args) {
                    console.log(`[PageMonitor] ${message}`, ...args);
                },
                
                reportTimings() {
                    const timings = {
                        totalTime: this.timestamps.load ? this.timestamps.load - this.timestamps.start : null,
                        domReadyTime: this.timestamps.domContentLoaded ? this.timestamps.domContentLoaded - this.timestamps.start : null,
                        scriptLoadTime: this.timestamps.scriptLoad ? this.timestamps.scriptLoad - this.timestamps.start : null,
                        userInputTime: this.timestamps.userInputListening ? this.timestamps.userInputListening - this.timestamps.start : null
                    };
                    
                    this.log('Timing Report:', timings);
                    
                    // Dispatch custom event with timing data
                    const timingEvent = new CustomEvent('pageLifecycleComplete', {
                        detail: {
                            timings,
                            events: this.events
                        }
                    });
                    window.dispatchEvent(timingEvent);
                }
            };
            
            // Initialize the monitor
            PageMonitor.init();
            
            // Make it globally accessible for debugging
            window.PageMonitor = PageMonitor;
            
        })();
    </script>
    
    <script src="script.js"></script>
</body>
</html>